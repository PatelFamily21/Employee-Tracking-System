{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <section class="py-10 bg-gray-50">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">Employee Management</h2>
                <div class="flex space-x-3">
                    <a href="{% url 'dashboard' %}" class="flex items-center text-indigo-600 hover:text-indigo-800 transition-all">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>

            <!-- Messages -->
            {% if messages %}
                <div class="mb-6">
                    {% for message in messages %}
                        <div class="mb-4 p-4 rounded-lg flex items-center {% if message.tags == 'success' %}bg-green-100 text-green-700 border-l-4 border-green-500{% else %}bg-red-100 text-red-700 border-l-4 border-red-500{% endif %}">
                            <i class="{% if message.tags == 'success' %}fas fa-check-circle{% else %}fas fa-exclamation-circle{% endif %} mr-3 text-lg"></i>
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Add Employee Form -->
            <div class="max-w-6xl mx-auto px-4">
                <!-- Form section -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-8">
                    <!-- Form header -->
                    <div class="bg-indigo-600 text-white px-6 py-4">
                        <h2 class="text-xl font-semibold">Add New Employee</h2>
                    </div>
                    
                    <!-- Form body -->
                    <div class="p-6">
                        <form method="post" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {% csrf_token %}
                            {% for field in form %}
                                {% if field.name == 'can_assign_cross_department' %}
                                    <div>
                                        <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ field.label }}</label>
                                        <div class="flex items-center">
                                            {{ field }}
                                            <span class="ml-2 text-sm text-gray-500">Allow cross-department task assignment</span>
                                        </div>
                                        {% if field.errors %}
                                            <p class="text-red-600 text-sm mt-1">{{ field.errors }}</p>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <div>
                                        <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ field.label }}</label>
                                        {% if field.name == 'dOB' or field.name == 'joinDate' %}
                                            <div class="relative">
                                                {{ field }}
                                                <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                                    <i class="fas fa-calendar-alt text-gray-400"></i>
                                                </div>
                                            </div>
                                        {% else %}
                                            {{ field }}
                                        {% endif %}
                                        {% if field.errors %}
                                            <p class="text-red-600 text-sm mt-1">{{ field.errors }}</p>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                            <div class="md:col-span-2">
                                <button type="submit" name="action" value="add" class="flex items-center justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all">
                                    <i class="fas fa-user-plus mr-2"></i>Add Employee
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

            <!-- Employee List -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="bg-indigo-600 text-white px-6 py-4">
                    <h2 class="text-xl font-semibold">Employee List</h2>
                </div>
                
                <div class="p-6">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">EID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cross-Dept Assign</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for emp in employees %}
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ emp.eID }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ emp.firstName }} {{ emp.lastName }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ emp.role }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ emp.department.name|default:"â€”" }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                                            {% if emp.can_assign_cross_department %}
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Yes</span>
                                            {% else %}
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">No</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                            <div class="flex items-center justify-center">
                                                <i class="fas fa-user-slash mr-2"></i>No employees found.
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Apply styles to all form inputs
            const allInputs = document.querySelectorAll('form input, form select, form textarea');
            allInputs.forEach(input => {
                if (input.type !== 'checkbox') {
                    input.classList.add('w-full', 'px-4', 'py-2', 'border', 'border-gray-300', 'rounded-lg', 'focus:outline-none', 'focus:ring-2', 'focus:ring-indigo-500', 'focus:border-transparent');
                }
            });

            // Style the checkbox
            const checkbox = document.querySelector('input[name="can_assign_cross_department"]');
            if (checkbox) {
                checkbox.classList.add('h-4', 'w-4', 'text-indigo-600', 'border-gray-300', 'rounded', 'focus:ring-indigo-500');
            }
            
            // Initialize flatpickr for date fields
            flatpickr('input[name="dOB"]', {
                dateFormat: 'Y-m-d',
                allowInput: true,
                maxDate: new Date() // Prevents future dates for DOB
            });
            
            flatpickr('input[name="joinDate"]', {
                dateFormat: 'Y-m-d',
                allowInput: true
            });

            // Dynamically enable/disable the can_assign_cross_department checkbox based on designation
            const designationSelect = document.querySelector('select[name="designation"]');
            const canAssignCheckbox = document.querySelector('input[name="can_assign_cross_department"]');
            const canAssignLabel = canAssignCheckbox ? canAssignCheckbox.closest('div').querySelector('label') : null;
            const canAssignSpan = canAssignCheckbox ? canAssignCheckbox.closest('div').querySelector('span') : null;

            if (designationSelect && canAssignCheckbox && canAssignLabel && canAssignSpan) {
                const updateCheckboxState = () => {
                    const designation = designationSelect.value;
                    const restrictedDesignations = ['HR', 'Admin', 'Project Manager', 'Team Leader'];
                    const isRestricted = !restrictedDesignations.includes(designation);

                    if (isRestricted) {
                        canAssignCheckbox.disabled = true;
                        canAssignCheckbox.checked = false;
                        canAssignLabel.classList.add('text-gray-400');
                        canAssignSpan.classList.add('text-gray-400');
                        canAssignCheckbox.classList.remove('text-indigo-600', 'focus:ring-indigo-500');
                        canAssignCheckbox.classList.add('text-gray-300');
                        canAssignCheckbox.setAttribute('title', "Cross-department assignment is not available for employees with the 'employee' role.");
                    } else {
                        canAssignCheckbox.disabled = false;
                        canAssignLabel.classList.remove('text-gray-400');
                        canAssignSpan.classList.remove('text-gray-400');
                        canAssignCheckbox.classList.add('text-indigo-600', 'focus:ring-indigo-500');
                        canAssignCheckbox.classList.remove('text-gray-300');
                        canAssignCheckbox.removeAttribute('title');
                    }
                };

                // Initial state
                updateCheckboxState();

                // Update state on designation change
                designationSelect.addEventListener('change', updateCheckboxState);
            }
        });
    </script>
{% endblock %}